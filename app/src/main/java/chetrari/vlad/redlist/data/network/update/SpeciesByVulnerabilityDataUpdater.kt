package chetrari.vlad.redlist.data.network.update

import chetrari.vlad.redlist.data.network.api.RedListApi
import chetrari.vlad.redlist.data.network.model.SpeciesResponse
import chetrari.vlad.redlist.data.persistence.model.Species
import chetrari.vlad.redlist.data.persistence.type.Vulnerability
import io.objectbox.Box
import javax.inject.Inject
import javax.inject.Singleton

@Singleton
class SpeciesByVulnerabilityDataUpdater @Inject constructor(
    private val api: RedListApi,
    private val box: Box<Species>
) : DataUpdater<Vulnerability, List<SpeciesResponse>, List<Species>>() {

    override suspend fun fetch(input: Vulnerability) = api.speciesByCategory(input.toString()).body.result

    override suspend fun map(input: Vulnerability, response: List<SpeciesResponse>) = response.map {
        Species(id = it.taxonId, category = input, scientificName = it.scientificName)
    }

    override suspend fun persist(input: Vulnerability, output: List<Species>) {
        val entities = output
            .map { (box[it.id] ?: Species()) to it }
            .map {
                it.first.id = it.second.id
                it.first.category = it.second.category
                it.first.scientificName = it.second.scientificName
                it.first
            }
        entities.forEach(box::attach)
        box.put(entities)
    }
}